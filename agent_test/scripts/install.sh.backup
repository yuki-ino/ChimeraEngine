#!/bin/bash

# ğŸ¦ Chimera Engine - ãƒ¯ãƒ³ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼
# Usage: curl -sSL https://raw.githubusercontent.com/yuki-ino/ChimeraEngine/main/install.sh | bash

set -e

# è¨­å®š
INSTALL_DIR="${CHIMERA_DIR:-$HOME/.chimera}"
REPO_URL="https://github.com/yuki-ino/ChimeraEngine.git"
BRANCH="main"

# è‰²ä»˜ãå‡ºåŠ›
print_color() {
    local color=$1
    shift
    echo -e "\033[${color}m$@\033[0m"
}

info() { print_color "1;32" "[INFO] $@"; }
warn() { print_color "1;33" "[WARN] $@"; }
error() { print_color "1;31" "[ERROR] $@"; }
success() { print_color "1;34" "[SUCCESS] $@"; }

# ãƒ˜ãƒƒãƒ€ãƒ¼
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          Chimera Engine               â•‘
â•‘       Quick Installer v0.0.1          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

# ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
info "ä¾å­˜é–¢ä¿‚ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

check_command() {
    if ! command -v $1 &> /dev/null; then
        error "$1 ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚"
        return 1
    fi
    success "âœ“ $1"
}

check_command git || exit 1
check_command tmux || exit 1
check_command curl || check_command wget || exit 1

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
info "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ: $INSTALL_DIR"
mkdir -p "$INSTALL_DIR"

# ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆGitHubã‹ã‚‰ç›´æ¥ã€ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚³ãƒ”ãƒ¼ï¼‰
if [ -d "$(pwd)/instructions" ] && [ -f "$(pwd)/setup-chimera.sh" ]; then
    info "ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
    cp -r setup-chimera.sh chimera-send.sh pm-workflow-controller.sh instructions "$INSTALL_DIR/"
else
    info "GitHubã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰..."
    cd "$INSTALL_DIR"
    
    # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    files=(
        "setup-chimera.sh"
        "chimera-send.sh"
        "pm-workflow-controller.sh"
        "project-analyzer.sh"
        "test-manual-generator.sh"
        "instructions/pm.md"
        "instructions/coder.md"
        "instructions/qa-functional.md"
        "instructions/qa-lead.md"
    )
    
    for file in "${files[@]}"; do
        dir=$(dirname "$file")
        mkdir -p "$dir"
        curl -sSL "https://raw.githubusercontent.com/yuki-ino/ChimeraEngine/$BRANCH/$file" -o "$file" || \
        wget -q "https://raw.githubusercontent.com/yuki-ino/ChimeraEngine/$BRANCH/$file" -O "$file"
    done
fi

# å®Ÿè¡Œæ¨©é™ä»˜ä¸
chmod +x "$INSTALL_DIR/setup-chimera.sh" "$INSTALL_DIR/chimera-send.sh" "$INSTALL_DIR/pm-workflow-controller.sh"

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒãƒ³ãƒ‰ä½œæˆ
info "ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’ä½œæˆä¸­..."

# chimeraã‚³ãƒãƒ³ãƒ‰ã®ä½œæˆ
cat > "$INSTALL_DIR/chimera" << 'SCRIPT'
#!/bin/bash
# Chimera Engine System - ãƒ¡ã‚¤ãƒ³ã‚³ãƒãƒ³ãƒ‰

CHIMERA_HOME="${CHIMERA_DIR:-$HOME/.chimera}"
COMMAND=$1
shift

case "$COMMAND" in
    init)
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«Chimera Engineã‚’åˆæœŸåŒ–
        cp -r "$CHIMERA_HOME/"{setup-chimera.sh,chimera-send.sh,pm-workflow-controller.sh,instructions} .
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè§£æãƒ„ãƒ¼ãƒ«ã‚‚ã‚³ãƒ”ãƒ¼
        if [ -f "$CHIMERA_HOME/project-analyzer.sh" ]; then
            cp "$CHIMERA_HOME/project-analyzer.sh" .
        fi
        if [ -f "$CHIMERA_HOME/test-manual-generator.sh" ]; then
            cp "$CHIMERA_HOME/test-manual-generator.sh" .
        fi
        if [ -f "$CHIMERA_HOME/pm-workflow-controller.sh" ]; then
            cp "$CHIMERA_HOME/pm-workflow-controller.sh" .
        fi
        
        chmod +x *.sh
        
        # è‡ªå‹•ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè§£æã¨ãƒ†ã‚¹ãƒˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”Ÿæˆ
        if command -v jq &> /dev/null; then
            echo "ğŸ” ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è§£æä¸­..."
            ./project-analyzer.sh .
            echo "ğŸ“– ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’ç”Ÿæˆä¸­..."
            ./test-manual-generator.sh .
            echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’è¨­å®šã—ã¾ã—ãŸ"
        else
            echo "âš ï¸  jqãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ¨™æº–ã®ãƒ†ã‚¹ãƒˆæŒ‡ç¤ºæ›¸ã‚’ä½¿ç”¨ã—ã¾ã™"
            echo "   è©³ç´°è§£æã«ã¯ 'brew install jq' ã¾ãŸã¯ 'apt install jq' ã§jqã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"
        fi
        
        echo "âœ… Chimera Engineã‚·ã‚¹ãƒ†ãƒ ã‚’ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«åˆæœŸåŒ–ã—ã¾ã—ãŸ"
        echo "å®Ÿè¡Œ: chimera start"
        ;;
    
    start)
        # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨èµ·å‹•
        if [ ! -f "./setup-chimera.sh" ]; then
            "$0" init
        fi
        ./setup-chimera.sh
        ;;
    
    send)
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        if [ ! -f "./chimera-send.sh" ]; then
            echo "ã‚¨ãƒ©ãƒ¼: chimera-send.sh ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'chimera init' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
            exit 1
        fi
        ./chimera-send.sh "$@"
        ;;
    
    update)
        # ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
        echo "Chimera Engineã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆä¸­..."
        cd "$CHIMERA_HOME"
        curl -sSL https://raw.githubusercontent.com/yuki-ino/ChimeraEngine/main/install.sh | bash
        ;;
    
    help|--help|-h|"")
        cat << EOF
Chimera Engine - Multi-Agent Development System

ä½¿ç”¨æ–¹æ³•:
  chimera <command> [options]

ã‚³ãƒãƒ³ãƒ‰:
  init      ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«Chimera Engineã‚’åˆæœŸåŒ–
  start     ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç’°å¢ƒã‚’èµ·å‹•
  send      ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
  update    ã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
  help      ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ä¾‹:
  chimera init                    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆæœŸåŒ–
  chimera start                   # ç’°å¢ƒèµ·å‹•
  chimera send coder "å®Ÿè£…é–‹å§‹"   # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡

è©³ç´°:
  https://github.com/yuki-ino/ChimeraEngine
EOF
        ;;
    
    *)
        echo "ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: $COMMAND"
        echo "ä½¿ç”¨æ–¹æ³•: chimera help"
        exit 1
        ;;
esac
SCRIPT

chmod +x "$INSTALL_DIR/chimera"

# PATHè¨­å®šã®ææ¡ˆ
info "PATHè¨­å®šã‚’ç¢ºèªä¸­..."

add_to_path() {
    local shell_rc=""
    
    if [ -n "$BASH_VERSION" ]; then
        shell_rc="$HOME/.bashrc"
    elif [ -n "$ZSH_VERSION" ]; then
        shell_rc="$HOME/.zshrc"
    fi
    
    if [ -n "$shell_rc" ] && [ -f "$shell_rc" ]; then
        if ! grep -q "CHIMERA_DIR" "$shell_rc"; then
            cat >> "$shell_rc" << EOF

# Chimera Engine System
export CHIMERA_DIR="$INSTALL_DIR"
export PATH="\$CHIMERA_DIR:\$PATH"
EOF
            success "PATHè¨­å®šã‚’ $shell_rc ã«è¿½åŠ ã—ã¾ã—ãŸ"
            warn "æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ãã‹ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
            echo "  source $shell_rc"
        fi
    fi
}

add_to_path

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†
echo ""
success "ğŸ‰ Chimera Engineã‚·ã‚¹ãƒ†ãƒ ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo ""
echo "ğŸ“‹ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ:"
echo "  1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•"
echo "  2. chimera init    # åˆæœŸåŒ–"
echo "  3. chimera start   # èµ·å‹•"
echo ""
echo "ğŸ’¡ ä»Šã™ãä½¿ã†ã«ã¯:"
echo "  export PATH=\"$INSTALL_DIR:\$PATH\""
echo "  chimera help"
echo ""

# ä¸€æ™‚çš„ã«PATHã«è¿½åŠ ï¼ˆç¾åœ¨ã®ã‚·ã‚§ãƒ«ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨ï¼‰
export PATH="$INSTALL_DIR:$PATH"