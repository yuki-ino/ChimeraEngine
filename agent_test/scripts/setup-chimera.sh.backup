#!/bin/bash

# ğŸ¦ Chimera Engine - Multi-Agent Development Environment
# QA Team Specialization: Functional Testing + Quality Management

set -e

# è‰²ä»˜ããƒ­ã‚°é–¢æ•°
log_info() {
    echo -e "\033[1;32m[INFO]\033[0m $1"
}

log_success() {
    echo -e "\033[1;34m[SUCCESS]\033[0m $1"
}

echo "ğŸ¦ Chimera Engine v0.0.1 - Multi-Agent Development Environment Setup"
echo "====================================================================="
echo ""

# STEP 1: æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
log_info "ğŸ§¹ æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹..."

tmux kill-session -t chimera-workspace 2>/dev/null && log_info "chimera-workspaceã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤å®Œäº†" || log_info "chimera-workspaceã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã§ã—ãŸ"
tmux kill-session -t pmproject 2>/dev/null && log_info "pmprojectã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤å®Œäº†" || log_info "pmprojectã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã§ã—ãŸ"
tmux kill-session -t deveng 2>/dev/null && log_info "devengã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤å®Œäº†" || log_info "devengã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã§ã—ãŸ"
tmux kill-session -t devqa 2>/dev/null && log_info "devqaã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤å®Œäº†" || log_info "devqaã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã§ã—ãŸ"

# Chimeraå°‚ç”¨ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’æ±šã•ãªã„ï¼‰
CHIMERA_WORKSPACE_DIR="${TMPDIR:-/tmp}/chimera-workspace-$$"
mkdir -p "$CHIMERA_WORKSPACE_DIR/status" "$CHIMERA_WORKSPACE_DIR/logs"
log_info "Chimeraä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $CHIMERA_WORKSPACE_DIR"

# æ—¢å­˜ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªã‚¢
rm -f "$CHIMERA_WORKSPACE_DIR/status"/*.txt 2>/dev/null && log_info "æ—¢å­˜ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢" || log_info "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã§ã—ãŸ"

log_success "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
echo ""

# STEP 2: çµ±åˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆ1ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦6ãƒšã‚¤ãƒ³æ§‹æˆï¼‰
log_info "ğŸ—ï¸ Chimeraçµ±åˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆé–‹å§‹..."

# ãƒ¡ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
log_info "ãƒ¡ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ 'chimera-workspace' ä½œæˆä¸­..."
tmux new-session -d -s chimera-workspace -n "chimera-dev"

# ãƒã‚¦ã‚¹æ“ä½œã‚’æœ‰åŠ¹åŒ–
log_info "ãƒã‚¦ã‚¹æ“ä½œã‚’æœ‰åŠ¹åŒ–ä¸­..."
tmux set-option -g mouse on

# ãƒšã‚¤ãƒ³åˆ†å‰²: ä¸Š1/3 - PM
log_info "ãƒšã‚¤ãƒ³åˆ†å‰²ä¸­..."
tmux split-window -v -t "chimera-workspace:0" -p 66  # ä¸Š1/3ã‚’PMã«

# ä¸­1/3 - é–‹ç™ºè€…ï¼ˆæ®‹ã‚Šã®ä¸ŠåŠåˆ†ï¼‰
tmux split-window -v -t "chimera-workspace:0.1" -p 50  # æ®‹ã‚Š2/3ã®ä¸ŠåŠåˆ†ã‚’é–‹ç™ºè€…ã«

# ä¸‹1/3 - QAï¼ˆ3ã¤ã«åˆ†å‰²ï¼‰
tmux split-window -h -t "chimera-workspace:0.2" -p 66  # QA1
tmux split-window -h -t "chimera-workspace:0.3" -p 50  # QA2, QA3

# ãƒšã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
tmux select-pane -t "chimera-workspace:0.0" -T "PM"
tmux select-pane -t "chimera-workspace:0.1" -T "Coder"  
tmux select-pane -t "chimera-workspace:0.2" -T "QA-Functional"
tmux select-pane -t "chimera-workspace:0.3" -T "QA-Lead"
tmux select-pane -t "chimera-workspace:0.4" -T "Monitor"

log_info "å„ãƒšã‚¤ãƒ³ã®è¨­å®šä¸­..."

# ãƒšã‚¤ãƒ³0: PM (ä¸Š1/3)
tmux send-keys -t "chimera-workspace:0.0" "cd $(pwd)" C-m
tmux send-keys -t "chimera-workspace:0.0" "export PS1='(\[\033[1;31m\]PM\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
tmux send-keys -t "chimera-workspace:0.0" "echo '=== ğŸ¯ PM (Product Manager) ==='" C-m
tmux send-keys -t "chimera-workspace:0.0" "echo 'ä¼ç”»ãƒ»è¦ä»¶å®šç¾©ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†'" C-m
tmux send-keys -t "chimera-workspace:0.0" "echo 'ğŸ¤– Claude Codeèµ·å‹•ä¸­...'" C-m
tmux send-keys -t "chimera-workspace:0.0" "claude --dangerously-skip-permissions" C-m

# ãƒšã‚¤ãƒ³1: Coder (ä¸­1/3)  
tmux send-keys -t "chimera-workspace:0.1" "cd $(pwd)" C-m
tmux send-keys -t "chimera-workspace:0.1" "export PS1='(\[\033[1;36m\]Coder\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
tmux send-keys -t "chimera-workspace:0.1" "echo '=== ğŸ‘¨â€ğŸ’» Coder (ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯é–‹ç™ºè€…) ==='" C-m
tmux send-keys -t "chimera-workspace:0.1" "echo 'Frontend/Backend/Mobile å…¨å¯¾å¿œ'" C-m
tmux send-keys -t "chimera-workspace:0.1" "echo 'ğŸ¤– Claude Codeèµ·å‹•ä¸­...'" C-m
tmux send-keys -t "chimera-workspace:0.1" "claude --dangerously-skip-permissions" C-m

# ãƒšã‚¤ãƒ³2: QA-Functional (ä¸‹1/3ã®å·¦)
tmux send-keys -t "chimera-workspace:0.2" "cd $(pwd)" C-m
tmux send-keys -t "chimera-workspace:0.2" "export PS1='(\[\033[1;33m\]QA-Func\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
tmux send-keys -t "chimera-workspace:0.2" "echo '=== ğŸ§ª QA-Functional ==='" C-m
tmux send-keys -t "chimera-workspace:0.2" "echo 'æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆãƒ»ãƒã‚°æ¤œå‡º'" C-m
tmux send-keys -t "chimera-workspace:0.2" "echo 'ğŸ¤– Claude Codeèµ·å‹•ä¸­...'" C-m
tmux send-keys -t "chimera-workspace:0.2" "claude --dangerously-skip-permissions" C-m

# ãƒšã‚¤ãƒ³3: QA-Lead (ä¸‹1/3ã®ä¸­å¤®)
tmux send-keys -t "chimera-workspace:0.3" "cd $(pwd)" C-m
tmux send-keys -t "chimera-workspace:0.3" "export PS1='(\[\033[1;31m\]QA-Lead\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
tmux send-keys -t "chimera-workspace:0.3" "echo '=== ğŸ‘‘ QA-Lead ==='" C-m
tmux send-keys -t "chimera-workspace:0.3" "echo 'å“è³ªç®¡ç†ãƒ»ãƒªãƒªãƒ¼ã‚¹åˆ¤å®š'" C-m
tmux send-keys -t "chimera-workspace:0.3" "echo 'ğŸ¤– Claude Codeèµ·å‹•ä¸­...'" C-m
tmux send-keys -t "chimera-workspace:0.3" "claude --dangerously-skip-permissions" C-m

# ãƒšã‚¤ãƒ³4: Monitor (ä¸‹1/3ã®å³)
tmux send-keys -t "chimera-workspace:0.4" "cd $(pwd)" C-m
tmux send-keys -t "chimera-workspace:0.4" "export PS1='(\[\033[1;35m\]Monitor\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ '" C-m
tmux send-keys -t "chimera-workspace:0.4" "echo '=== ğŸ“Š Monitor ==='" C-m
tmux send-keys -t "chimera-workspace:0.4" "echo 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦–ãƒ»ãƒ¬ãƒãƒ¼ãƒˆ'" C-m
tmux send-keys -t "chimera-workspace:0.4" "echo 'ğŸ¤– Claude Codeèµ·å‹•ä¸­...'" C-m
tmux send-keys -t "chimera-workspace:0.4" "claude --dangerously-skip-permissions" C-m

log_success "âœ… çµ±åˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆå®Œäº†"
echo ""

echo ""
log_info "ğŸ” ç’°å¢ƒç¢ºèªä¸­..."

echo ""
echo "ğŸ“Š ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çµæœ:"
echo "==================="

# tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
echo "ğŸ“º Tmux Sessions:"
tmux list-sessions
echo ""

# ãƒšã‚¤ãƒ³æ§‹æˆè¡¨ç¤º
echo "ğŸ“‹ çµ±åˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æ§‹æˆ:"
echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "  â”‚ PM (ä¸Š1/3)                      â”‚ â† ğŸ¯ ä¼ç”»ãƒ»ç®¡ç†"  
echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
echo "  â”‚ Coder (ä¸­1/3)                   â”‚ â† ğŸ‘¨â€ğŸ’» ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯é–‹ç™º"
echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
echo "  â”‚QA-Func    â”‚QA-Lead    â”‚Monitor  â”‚ â† ğŸ§ªğŸ‘‘ğŸ“Š å“è³ªç®¡ç†"
echo "  â”‚(ä¸‹1/3å·¦)  â”‚(ä¸‹1/3ä¸­)  â”‚(ä¸‹1/3å³) â”‚"
echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

echo ""
echo "ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ:"
echo "  $CHIMERA_WORKSPACE_DIR/status/  - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ãƒ•ã‚¡ã‚¤ãƒ«"
echo "  $CHIMERA_WORKSPACE_DIR/logs/    - å„ç¨®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«"
echo "  â€»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã¯æ±šã—ã¾ã›ã‚“"

echo ""
log_success "ğŸ‰ Chimera Engine çµ±åˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å®Œæˆï¼"
echo ""
echo "ğŸ“‹ è‡ªå‹•æ§‹æˆå®Œäº†:"
echo "  âœ… 1ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦5ãƒšã‚¤ãƒ³è‡ªå‹•åˆ†å‰²"
echo "  âœ… å…¨ãƒšã‚¤ãƒ³ã§ Claude Code èµ·å‹•ä¸­"
echo "  âœ… ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«è‡ªå‹•æ¥ç¶š"
echo ""
echo "ğŸ¯ ãƒšã‚¤ãƒ³æ“ä½œ:"
echo "  ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯    (ãƒšã‚¤ãƒ³é¸æŠ)"
echo "  Ctrl+b, â†‘â†“â†â†’  (ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒšã‚¤ãƒ³ç§»å‹•)"
echo "  Ctrl+b, z      (ãƒšã‚¤ãƒ³æœ€å¤§åŒ–/å¾©å…ƒ)"
echo "  Ctrl+b, d      (ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ã‚¿ãƒƒãƒ)"
echo ""
echo "ğŸ“¤ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé€šä¿¡:"
echo "  chimera send pm \"æŒ‡ç¤ºå†…å®¹\""
echo "  chimera send coder \"å®Ÿè£…å†…å®¹\""
echo "  chimera send qa-functional \"ãƒ†ã‚¹ãƒˆå†…å®¹\""
echo ""

# Claude Codeã®èµ·å‹•ã‚’å¾…ã¤
log_info "Claude Codeèµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
sleep 5

# èªè¨¼ç”»é¢ã§è‡ªå‹•çš„ã« "2" (Accept) ã‚’é€ä¿¡
log_info "Claude Codeèªè¨¼ã‚’è‡ªå‹•å®Ÿè¡Œä¸­..."
echo "  â†’ å…¨ãƒšã‚¤ãƒ³ã«èªè¨¼ã‚³ãƒãƒ³ãƒ‰ (2=Accept) ã‚’é€ä¿¡..."
for i in {0..4}; do
    tmux send-keys -t "chimera-workspace:0.$i" "2" C-m
    echo "    ãƒšã‚¤ãƒ³ $i: èªè¨¼é€ä¿¡å®Œäº†"
done
sleep 3

# èªè¨¼ãŒå®Œäº†ã—ã¦ã„ãªã„å ´åˆã®ãŸã‚ã€ã‚‚ã†ä¸€åº¦é€ä¿¡
log_info "èªè¨¼ç¢ºèªã‚’å†å®Ÿè¡Œä¸­..."
for i in {0..4}; do
    tmux send-keys -t "chimera-workspace:0.$i" "2" C-m
done
sleep 2

echo ""
log_success "ğŸš€ çµ±åˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«æ¥ç¶šã—ã¾ã™..."
echo "ğŸ“ PMãƒšã‚¤ãƒ³(ä¸Šéƒ¨)ã§ã€Œã‚ãªãŸã¯PMã§ã™ã€‚æŒ‡ç¤ºæ›¸ã«å¾“ã£ã¦ã€ã¨å…¥åŠ›ã—ã¦ãƒ‡ãƒ¢é–‹å§‹"
echo "ğŸ’¡ èªè¨¼ã¯è‡ªå‹•å®Œäº†æ¸ˆã¿ - ã™ãã«ä½¿ç”¨ã§ãã¾ã™"
echo ""

# PMãƒšã‚¤ãƒ³ï¼ˆãƒšã‚¤ãƒ³0ï¼‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
tmux select-pane -t chimera-workspace:0.0

# çµ±åˆãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ã‚¢ã‚¿ãƒƒãƒ
tmux attach-session -t chimera-workspace