#!/bin/bash

# ğŸ­ Agent Identity & Role Recognition System for Chimera Engine
# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒç¢ºèªãƒ»å½¹å‰²èªè­˜ã‚·ã‚¹ãƒ†ãƒ 

AGENT_IDENTITY_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${AGENT_IDENTITY_DIR}/common.sh"
source "${AGENT_IDENTITY_DIR}/plan-manager.sh"

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒæƒ…å ±ï¼ˆmacOS bash 3.x compatibleï¼‰
# declare -A AGENT_IDENTITY_INFO  # Disabled for macOS compatibility

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒåˆæœŸåŒ–
init_agent_identity() {
    log_info "ğŸ­ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒèªè­˜ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­..."
    
    local identity_dir="${CHIMERA_WORKSPACE_DIR}/agent_identity"
    safe_mkdir "$identity_dir"
    safe_mkdir "${identity_dir}/roles"
    safe_mkdir "${identity_dir}/context"
    safe_mkdir "${identity_dir}/session_state"
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒæƒ…å ±å®šç¾©ï¼ˆfunction-based for macOS compatibilityï¼‰
    # AGENT_IDENTITY_INFO is replaced with get_agent_identity function
    
    # å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®èº«å…ƒãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    local agents=("pm" "coder" "qa-functional" "qa-lead" "monitor")
    for agent in "${agents[@]}"; do
        create_agent_identity_file "$agent"
    done
    
    log_success "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒèªè­˜ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†"
}

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
create_agent_identity_file() {
    local agent="$1"
    local identity="${AGENT_IDENTITY_INFO[$agent]}"
    local identity_file="${CHIMERA_WORKSPACE_DIR}/agent_identity/roles/${agent}_identity.md"
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©³ç´°æƒ…å ±
    local role_description=""
    local responsibilities=""
    local context_requirements=""
    
    case "$agent" in
        "pm")
            role_description="ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®çµ±æ‹¬ç®¡ç†"
            responsibilities="è¦ä»¶å®šç¾©ã€ã‚¿ã‚¹ã‚¯ç®¡ç†ã€é€²æ—ç›£è¦–ã€å“è³ªåˆ¤å®š"
            context_requirements="CHIMERA_PLAN.mdã€å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçŠ¶æ³ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›®æ¨™"
            ;;
        "coder")
            role_description="ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯é–‹ç™ºè€… - æ©Ÿèƒ½å®Ÿè£…ã¨ã‚³ãƒ¼ãƒ‰ä½œæˆ"
            responsibilities="å®Ÿè£…ã€ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€æŠ€è¡“çš„æ±ºå®šã€æˆæœç‰©ä½œæˆ"
            context_requirements="CHIMERA_PLAN.mdã€æŠ€è¡“ä»•æ§˜ã€å®Ÿè£…ã‚¿ã‚¹ã‚¯"
            ;;
        "qa-functional")
            role_description="æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå°‚é–€å®¶ - å€‹åˆ¥æ©Ÿèƒ½ã®è©³ç´°ãƒ†ã‚¹ãƒˆ"
            responsibilities="æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã€ãƒã‚°æ¤œå‡ºã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ"
            context_requirements="CHIMERA_PLAN.mdã€å®Ÿè£…çŠ¶æ³ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡"
            ;;
        "qa-lead")
            role_description="QAãƒªãƒ¼ãƒ‰ - å“è³ªç®¡ç†ã¨ãƒªãƒªãƒ¼ã‚¹åˆ¤å®š"
            responsibilities="å“è³ªåŸºæº–ç®¡ç†ã€æœ€çµ‚æ‰¿èªã€ãƒªãƒªãƒ¼ã‚¹åˆ¤å®š"
            context_requirements="CHIMERA_PLAN.mdã€å…¨ãƒ†ã‚¹ãƒˆçµæœã€å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹"
            ;;
        "monitor")
            role_description="ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ‹ã‚¿ãƒ¼ - çŠ¶æ³ç›£è¦–ã¨å ±å‘Š"
            responsibilities="é€²æ—ç›£è¦–ã€çŠ¶æ³å ±å‘Šã€ã‚·ã‚¹ãƒ†ãƒ å¥åº·åº¦ãƒã‚§ãƒƒã‚¯"
            context_requirements="CHIMERA_PLAN.mdã€å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ´»å‹•ã€ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹"
            ;;
    esac
    
    cat > "$identity_file" << EOF
# ğŸ­ ${identity} - èº«å…ƒç¢ºèªæ›¸

## ã‚ãªãŸã®èº«å…ƒ
**å½¹å‰²**: ${identity}
**èª¬æ˜**: ${role_description}

## è²¬ä»»ç¯„å›²
${responsibilities}

## å¿…è¦ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
${context_requirements}

## åˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
ã‚ãªãŸã¯ **${identity}** ã§ã™ã€‚

ä»¥ä¸‹ã®æ‰‹é †ã§å½¹å‰²ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

1. **èº«å…ƒç¢ºèª**: ã€Œç§ã¯${identity}ã§ã™ã€ã¨å®£è¨€
2. **CHIMERA_PLAN.mdèª­ã¿è¾¼ã¿**: æœ€æ–°ã®è¨ˆç”»çŠ¶æ³ã‚’ç¢ºèª
3. **ç¾åœ¨ã®çŠ¶æ³æŠŠæ¡**: è‡ªåˆ†ã«é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’ç‰¹å®š
4. **æº–å‚™å®Œäº†å ±å‘Š**: ä½œæ¥­æº–å‚™å®Œäº†ã‚’å ±å‘Š

## ç¾åœ¨æ™‚åˆ»
$(date '+%Y-%m-%d %H:%M:%S')

## ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
- ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: $(date)
- ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹: ${CHIMERA_WORKSPACE_DIR:-"æœªè¨­å®š"}
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ: ${CHIMERA_PROJECT_ROOT:-$(pwd)}

---
Generated by Chimera Engine Agent Identity System v${CHIMERA_VERSION}
EOF

    log_debug "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: $agent -> $identity_file"
}

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå½¹å‰²èªè­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
generate_role_recognition_message() {
    local agent="$1"
    local session_context="${2:-normal}"  # normal, startup, recovery
    
    local identity="${AGENT_IDENTITY_INFO[$agent]}"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # CHIMERA_PLAN.mdã®å­˜åœ¨ç¢ºèª
    local plan_status="å­˜åœ¨ã—ã¾ã›ã‚“"
    local plan_instruction=""
    
    if [[ -f "${PLAN_FILE}" ]]; then
        plan_status="åˆ©ç”¨å¯èƒ½"
        plan_instruction="å¿…ãšCHIMERA_PLAN.mdã‚’èª­ã¿è¾¼ã‚“ã§æœ€æ–°ã®çŠ¶æ³ã‚’æŠŠæ¡ã—ã¦ãã ã•ã„ã€‚"
    else
        plan_instruction="CHIMERA_PLAN.mdãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    fi
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    local context_message=""
    case "$session_context" in
        "startup")
            context_message="ğŸš€ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•æ™‚ã®åˆæœŸåŒ–ä¸­ã§ã™ã€‚"
            ;;
        "recovery")
            context_message="ğŸ”„ å›å¾©å‡¦ç†ä¸­ã§ã™ã€‚ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å†åŒæœŸã—ã¦ãã ã•ã„ã€‚"
            ;;
        "normal")
            context_message="ğŸ“‹ é€šå¸¸æ“ä½œã§ã®å½¹å‰²ç¢ºèªã§ã™ã€‚"
            ;;
    esac
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¥ã®å…·ä½“çš„ã‚¿ã‚¹ã‚¯ç¢ºèªæŒ‡ç¤º
    local task_instruction=""
    case "$agent" in
        "pm")
            task_instruction="æ‹…å½“: å…¨ä½“ç®¡ç†ã€è¦ä»¶å®šç¾©ã€é€²æ—ç›£è¦–ã€‚ç¾åœ¨ã®ã‚¹ãƒ—ãƒªãƒ³ãƒˆç›®æ¨™ã¨å…¨ä½“é€²æ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            ;;
        "coder")
            task_instruction="æ‹…å½“: å®Ÿè£…ä½œæ¥­ã€‚è‡ªåˆ†ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸé–‹ç™ºã‚¿ã‚¹ã‚¯ã¨æŠ€è¡“ä»•æ§˜ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            ;;
        "qa-functional")
            task_instruction="æ‹…å½“: æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã€‚ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®æ©Ÿèƒ½ã¨å®Ÿè¡Œã™ã¹ããƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            ;;
        "qa-lead")
            task_instruction="æ‹…å½“: å“è³ªç®¡ç†ã€‚å…¨ä½“çš„ãªå“è³ªçŠ¶æ³ã¨ãƒªãƒªãƒ¼ã‚¹åŸºæº–ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            ;;
        "monitor")
            task_instruction="æ‹…å½“: ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã€‚å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ´»å‹•çŠ¶æ³ã¨ã‚·ã‚¹ãƒ†ãƒ å¥åº·åº¦ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            ;;
    esac
    
    cat << EOF
ğŸ­ **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒç¢ºèªãƒ»å½¹å‰²èªè­˜**

**ã‚ãªãŸã¯ ${identity} ã§ã™ã€‚**

## ğŸ“‹ ç¾åœ¨ã®çŠ¶æ³
- æ™‚åˆ»: ${timestamp}
- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: ${context_message}
- CHIMERA_PLAN.md: ${plan_status}

## ğŸ¯ ã‚ãªãŸã®å½¹å‰²ã¨è²¬ä»»
${task_instruction}

## ğŸ“š å¿…é ˆç¢ºèªäº‹é …
1. **CHIMERA_PLAN.mdã‚’èª­ã¿è¾¼ã¿**: ${plan_instruction}
2. **è‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯ã‚’ç‰¹å®š**: å¾…æ©Ÿä¸­ãƒ»å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã‚’ç¢ºèª
3. **ç¾åœ¨ã®çŠ¶æ³ã‚’æŠŠæ¡**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®é€²æ—ã‚’ç†è§£
4. **æº–å‚™å®Œäº†ã‚’å ±å‘Š**: ã€Œ${identity} æº–å‚™å®Œäº†ã€ã¨å ±å‘Š

## ğŸ› ï¸ åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰
- \`chimera send update-task <ID> <status>\` - ã‚¿ã‚¹ã‚¯çŠ¶æ…‹æ›´æ–°
- \`chimera send status-update <from> <to> <ID> <progress> <work>\` - é€²æ—å ±å‘Š
- \`chimera send task-complete <from> <to> <ID> <summary>\` - å®Œäº†å ±å‘Š
- \`chimera send error-report <from> <to> <error>\` - ã‚¨ãƒ©ãƒ¼å ±å‘Š
- \`chimera send sync-plan\` - è¨ˆç”»åŒæœŸ

## âš¡ ä»Šã™ãå®Ÿè¡Œã—ã¦ãã ã•ã„
1. CHIMERA_PLAN.mdã‚’èª­ã¿è¾¼ã‚“ã§å†…å®¹ã‚’ç¢ºèª
2. ã€Œç§ã¯${identity}ã§ã™ã€‚CHIMERA_PLAN.mdã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ã€ã¨å¿œç­”
3. è‡ªåˆ†ã«é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Œã°çŠ¶æ³ã‚’å ±å‘Š

---
ğŸ¤– Generated by Chimera Engine v${CHIMERA_VERSION} at ${timestamp}
EOF
}

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å½¹å‰²èªè­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
send_role_recognition_to_agent() {
    local agent="$1"
    local session_context="${2:-normal}"
    
    log_info "ğŸ­ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ $agent ã«å½¹å‰²èªè­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­..."
    
    local message=$(generate_role_recognition_message "$agent" "$session_context")
    
    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    send_agent_message "$agent" "$message"
    
    # èº«å…ƒç¢ºèªãƒ­ã‚°
    local identity_log="${CHIMERA_WORKSPACE_DIR}/agent_identity/session_state/${agent}_recognition.log"
    echo "$(date -Iseconds) | ROLE_RECOGNITION | $session_context | Message sent" >> "$identity_log"
    
    log_success "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ $agent å½¹å‰²èªè­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†"
}

# å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å½¹å‰²èªè­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
send_role_recognition_to_all() {
    local session_context="${1:-startup}"
    
    log_info "ğŸ­ å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å½¹å‰²èªè­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­..."
    
    local agents=("pm" "coder" "qa-functional" "qa-lead" "monitor")
    
    for agent in "${agents[@]}"; do
        send_role_recognition_to_agent "$agent" "$session_context"
        sleep 1  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®é€ä¿¡é–“éš”
    done
    
    # å…¨ä½“é€ä¿¡ãƒ­ã‚°
    local global_log="${CHIMERA_WORKSPACE_DIR}/agent_identity/session_state/global_recognition.log"
    echo "$(date -Iseconds) | ALL_AGENTS | $session_context | Role recognition sent to all agents" >> "$global_log"
    
    log_success "å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå½¹å‰²èªè­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†"
}

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹æ™‚ã®åˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
send_project_initialization_message() {
    local project_name="${1:-"æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ"}"
    local project_description="${2:-"ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª¬æ˜æœªè¨­å®š"}"
    
    log_info "ğŸš€ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­..."
    
    # ã¾ãšCHIMERA_PLAN.mdã‚’åˆæœŸåŒ–
    if [[ ! -f "${PLAN_FILE}" ]]; then
        "${AGENT_IDENTITY_DIR}/plan-manager.sh" init
    fi
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’CHIMERA_PLAN.mdã«è¿½åŠ 
    local temp_file=$(mktemp)
    sed "s/(æœªå®š)/$project_name/g; s/ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹æ—¥: [0-9-]*/ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹æ—¥: $(date '+%Y-%m-%d')/g" "${PLAN_FILE}" > "$temp_file"
    mv "$temp_file" "${PLAN_FILE}"
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹ã®ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    local broadcast_message="ğŸš€ **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹é€šçŸ¥**

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: $project_name
èª¬æ˜: $project_description
é–‹å§‹æ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')

å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
1. è‡ªåˆ†ã®å½¹å‰²ã‚’ç¢ºèª
2. CHIMERA_PLAN.mdã‚’èª­ã¿è¾¼ã¿
3. æ‹…å½“ã‚¿ã‚¹ã‚¯ã‚’æŠŠæ¡
4. æº–å‚™å®Œäº†ã‚’å ±å‘Š

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæˆåŠŸã«å‘ã‘ã¦é€£æºã—ã¾ã—ã‚‡ã†ï¼"

    broadcast_message "$broadcast_message"
    
    # å€‹åˆ¥ã®å½¹å‰²èªè­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    send_role_recognition_to_all "startup"
    
    log_success "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†"
}

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒç¢ºèªçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
check_agent_recognition_status() {
    log_info "ğŸ­ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒç¢ºèªçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ä¸­..."
    
    local status_file="${CHIMERA_WORKSPACE_DIR}/agent_identity/recognition_status.md"
    
    cat > "$status_file" << 'EOF'
# ğŸ­ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒç¢ºèªçŠ¶æ…‹

ç”Ÿæˆæ—¥æ™‚: $(date)

## ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¥ç¢ºèªçŠ¶æ³

EOF
    
    local agents=("pm" "coder" "qa-functional" "qa-lead" "monitor")
    local all_recognized=true
    
    for agent in "${agents[@]}"; do
        local identity="${AGENT_IDENTITY_INFO[$agent]}"
        local log_file="${CHIMERA_WORKSPACE_DIR}/agent_identity/session_state/${agent}_recognition.log"
        local status="âŒ æœªç¢ºèª"
        local last_recognition="ãªã—"
        
        if [[ -f "$log_file" ]]; then
            local last_entry=$(tail -1 "$log_file" 2>/dev/null)
            if [[ -n "$last_entry" ]]; then
                last_recognition=$(echo "$last_entry" | cut -d'|' -f1)
                status="âœ… ç¢ºèªæ¸ˆã¿"
            else
                all_recognized=false
            fi
        else
            all_recognized=false
        fi
        
        echo "### $agent ($identity)" >> "$status_file"
        echo "- çŠ¶æ…‹: $status" >> "$status_file"
        echo "- æœ€çµ‚ç¢ºèª: $last_recognition" >> "$status_file"
        echo "" >> "$status_file"
    done
    
    echo "## ç·åˆçŠ¶æ³" >> "$status_file"
    if $all_recognized; then
        echo "âœ… **å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒç¢ºèªå®Œäº†**" >> "$status_file"
    else
        echo "âš ï¸ **ä¸€éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®èº«å…ƒç¢ºèªãŒæœªå®Œäº†**" >> "$status_file"
        echo "" >> "$status_file"
        echo "### æ¨å¥¨å¯¾å¿œ" >> "$status_file"
        echo "1. \`chimera send role-recognition-all\` ã§å†é€ä¿¡" >> "$status_file"
        echo "2. å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¿œç­”ã‚’ç¢ºèª" >> "$status_file"
        echo "3. å¿…è¦ã«å¿œã˜ã¦å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡" >> "$status_file"
    fi
    
    log_success "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèº«å…ƒç¢ºèªçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯å®Œäº†: $status_file"
    
    if $all_recognized; then
        return 0
    else
        return 1
    fi
}

# ç·Šæ€¥æ™‚ã®å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå†èªè­˜
emergency_agent_rerecognition() {
    log_warn "ğŸš¨ ç·Šæ€¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå†èªè­˜å‡¦ç†é–‹å§‹..."
    
    # æ—¢å­˜ã®èªè­˜ãƒ­ã‚°ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    local backup_dir="${CHIMERA_WORKSPACE_DIR}/agent_identity/backups/$(date +%Y%m%d_%H%M%S)"
    safe_mkdir "$backup_dir"
    cp -r "${CHIMERA_WORKSPACE_DIR}/agent_identity/session_state/"* "$backup_dir/" 2>/dev/null || true
    
    # ç·Šæ€¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    local emergency_message="ğŸš¨ **ç·Šæ€¥ã‚·ã‚¹ãƒ†ãƒ åŒæœŸ**

ã‚·ã‚¹ãƒ†ãƒ ãŒç·Šæ€¥å†èªè­˜ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯å³åº§ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

1. **èº«å…ƒç¢ºèª**: è‡ªåˆ†ãŒèª°ã‹ã‚’å®£è¨€
2. **CHIMERA_PLAN.mdå†èª­ã¿è¾¼ã¿**: æœ€æ–°çŠ¶æ³ã‚’ç¢ºèª
3. **ã‚¿ã‚¹ã‚¯çŠ¶æ³ç¢ºèª**: ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã‚’æŠŠæ¡
4. **æº–å‚™å®Œäº†å ±å‘Š**: ã€Œç·Šæ€¥åŒæœŸå®Œäº†ã€ã¨å ±å‘Š

æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"

    broadcast_message "$emergency_message"
    
    # å€‹åˆ¥å†èªè­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    send_role_recognition_to_all "recovery"
    
    # ç·Šæ€¥å‡¦ç†ãƒ­ã‚°
    local emergency_log="${CHIMERA_WORKSPACE_DIR}/agent_identity/emergency_rerecognition.log"
    echo "$(date -Iseconds) | EMERGENCY_RERECOGNITION | All agents notified" >> "$emergency_log"
    
    log_success "ç·Šæ€¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå†èªè­˜å‡¦ç†å®Œäº†"
}

# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    case "${1:-}" in
        "init")
            init_agent_identity
            ;;
        "send-recognition")
            send_role_recognition_to_agent "$2" "${3:-normal}"
            ;;
        "send-all")
            send_role_recognition_to_all "${2:-startup}"
            ;;
        "project-init")
            send_project_initialization_message "$2" "$3"
            ;;
        "check-status")
            check_agent_recognition_status
            ;;
        "emergency")
            emergency_agent_rerecognition
            ;;
        "generate-message")
            generate_role_recognition_message "$2" "${3:-normal}"
            ;;
        *)
            echo "Usage: $0 {init|send-recognition|send-all|project-init|check-status|emergency|generate-message}"
            exit 1
            ;;
    esac
fi